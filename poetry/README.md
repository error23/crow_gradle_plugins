# crow poetry plugin

This plugin is used to build python packages using poetry.
Since poetry doesn't know how to handle local dependencies, this plugin will use path develop = true dependencies to build the package and online source dependencies when ```poeteryUpdate.release=true```

## Basic usage

```groovy
plugins {
	plugins {
		id 'com.crow.gradle.plugins.poetry' version '1.3.0'
	}

	poetryConfig {
		projectPythonVersion = "3.12"
	}
}
```

### To initialize the environment you can run the following command

```bash
./gradlew poteryInitEnvirnoment
```

This will create a virtual environment in the project root directory and install all the dependencies.

### To build the package you can simply run

```bash
./gradlew poetryBuild
```

### note :

* When importing the project to intelliJ idea please refer to README.md generated by the plugin in the project root directory

### Adding dependencies

* To add new dependencies to the project you can use potery commands or pyproject.toml file
* In case you want to add a local dependency that you want in develop = true mode you can use the following syntax in pyproject.toml and build.gradle files

```pyproject.toml```

```toml
[tool.poetry.dependencies]
my-local-dependency = { path = "/path/to/your/local/dependency", develop = true }
```

```build.gradle```

```groovy
{
	dependencies {
		pythonImplementation project(path: ":my-local-dependency")
	}
}

```

The entry in gradle file is needed when building package with ```-p release=true``` flag.
All dependencies in pythonImplementation classpath will be replaced when release = true as follows

```toml 
[tool.poetry.dependencies]
my-local-dependency = my-local-dependency-version
```

### Advanced usage :

If you need to customize some plugin settings you can use following extension
All values presented here are default values set by plugin but in case you need to change some configuration here is complete description of the extension

```groovy
plugins {
	id 'com.crow.gradle.plugins.poetry' version '1.3.0'
}

poetryConfig {

	/**
	 *  Global poetry command to execute.
	 */
	poetryCmd = "poetry"

	/**
	 *  Global directory containing main python sources.
	 */
	mainSourcesDirectory = layout.projectDirectory.dir("src/main/python")

	/**
	 *  Global directory containing main resources.
	 */
	mainResourcesDirectory = layout.projectDirectory.dir("src/main/resources")

	/**
	 *  Global directory containing test python sources.
	 */
	testSourcesDirectory = layout.projectDirectory.dir("src/test/python")

	/**
	 *  Global directory containing test resources.
	 */
	testResourcesDirectory = layout.projectDirectory.dir("src/test/resources")

	/**
	 *  Global project name.
	 */
	projectName = project.name

	/**
	 *  Global project version.
	 */
	projectVersion = project.version.toString().replace("-SNAPSHOT", "a0")

	/**
	 *  Global project description.
	 */
	projectDescription = project.description.replaceFirst("'", "").replaceAll("'\$", "")

	/**
	 * Global readme file.
	 */
	readmeFile = layout.projectDirectory.file("README.md")

	/**
	 * Global project author.
	 */
	projectAuthor = project.findProperty("developerName").toString() + " <" + project.findProperty("developerEmail").toString() + ">"

	/**
	 * Global python project version.
	 */
	projectPythonVersion = '3.12'

	/**
	 * Global release flag.
	 * If true gradle will replace all local project dependencies with their online versions.
	 */
	release = false

	/**
	 * Global pyproject.toml file.
	 */
	pyprojectFile = layout.projectDirectory.file("pyproject.toml")

	/**
	 * [com.crow.gradle.plugins.poetry.tasks.init.PoetryConfigInitTask]
	 * specific configuration.
	 */
	poetryConfigInitTask {

		/**
		 * Overrides global Poetry command to execute.
		 */
		poetryCmd = "poetry"

		/**
		 * Poetry configuration file.
		 */
		poetryTomlFile = layout.projectDirectory.file("poetry.toml")
	}

	/**
	 * [com.crow.gradle.plugins.poetry.tasks.init.PoetryInitProjectStructureTask]
	 * specific configuration.
	 */
	poetryInitProjectStructureTask {

		/**
		 * Overrides global Poetry command to execute.
		 */
		poetryCmd = "poetry"

		/**
		 * Overrides global project name.
		 */
		projectName = project.name

		/**
		 * Overrides global directory containing main python sources.
		 * This is the directory where your main application python code lives.
		 */
		mainSourcesDirectory = layout.projectDirectory.dir("src/main/python")

		/**
		 * Overrides global directory containing main resources.
		 * This is the directory where your main application resources live.
		 */
		mainResourcesDirectory = layout.projectDirectory.dir("src/main/resources")

		/**
		 * Overrides global directory containing test python sources.
		 * This is the directory where your test python code lives.
		 */
		testSourcesDirectory = layout.projectDirectory.dir("src/test/python")

		/**
		 * Overrides global directory containing test resources.
		 * This is the directory where your test resources live.
		 */
		testResourcesDirectory = layout.projectDirectory.dir("src/test/resources")
	}

	/**
	 * [com.crow.gradle.plugins.poetry.tasks.init.PoetryInitReadMeTask]
	 * specific configuration.
	 */
	poetryInitReadMeTask {

		/**
		 * Overrides global Poetry command to execute.
		 */
		poetryCmd = "poetry"

		/**
		 * Overrides global project name.
		 */
		projectName = project.name

		/**
		 * Overrides global project description.
		 */
		projectDescription = project.description.replaceFirst("'", "").replaceAll("'\$", "")

		/**
		 * Overrides global readme file.
		 */
		readmeFile = layout.projectDirectory.file("README.md")

	}

	/**
	 * [com.crow.gradle.plugins.poetry.tasks.init.PoetryInitPyProjectTask]
	 * specific configuration.
	 */
	poetryInitPyProjectTask {

		/**
		 * Overrides global Poetry command to execute.
		 */
		poetryCmd = "poetry"

		/**
		 * Overrides global project name.
		 */
		projectName = project.name

		/**
		 * Overrides global project version.
		 */
		projectVersion = project.version.toString().replace("-SNAPSHOT", "a0")

		/**
		 * Overrides global project description.
		 */
		projectDescription = project.description.replaceFirst("'", "").replaceAll("'\$", "")

		/**
		 * Overrides global project author.
		 */
		projectAuthor = project.findProperty("developerName").toString() + " <" + project.findProperty("developerEmail").toString() + ">"

		/**
		 * Project homepage.
		 */
		projectHomepage = project.findProperty("projectUrl")?.toString()

		/**
		 * Project repository.
		 */
		projectRepository = project.findProperty("projectUrl")?.toString()

		/**
		 * Overrides global readme file.
		 */
		readmeFile = layout.projectDirectory.file("README.md")

		/**
		 * Overrides global python project version.
		 */
		projectPythonVersion = '3.12'

		/**
		 * Overrides global Directory containing main python sources.
		 */
		mainSourcesDirectory = layout.projectDirectory.dir("src/main/python")

		/**
		 * Overrides global Directory containing main resources.
		 */
		mainResourcesDirectory = layout.projectDirectory.dir("src/main/resources")

		/**
		 * Overrides global Directory containing test python sources.
		 */
		testSourcesDirectory = layout.projectDirectory.dir("src/test/python")

		/**
		 * Overrides global Directory containing test resources.
		 */
		testResourcesDirectory = layout.projectDirectory.dir("src/test/resources")

		/**
		 * Overrides global pyproject.toml file.
		 */
		pyprojectFile = layout.projectDirectory.file("pyproject.toml")
	}

	poetryInitEnvironmentTask {

		/**
		 * Overrides global Poetry command to execute.
		 */
		poetryCmd = "poetry"

		/**
		 * Overrides global python project version.
		 */
		projectPythonVersion = '3.12'

		/**
		 * Directory containing virtual environment.
		 */
		virtualEnvironmentDirectory = layout.projectDirectory.dir(".venv")
	}

	/**
	 * You should not modify this extension unless you know what you are doing.
	 */
	poetryIdeaSyncTask {

		/**
		 * Module iml file.
		 *
		 * Note : You should really not modify this value since is calculated by findModuleImlFile method in order to find right .iml file.
		 */
		moduleImlFile = project.layout.projectDirectory.dir(".idea").dir("modules").file(project.name + ".iml")

		/**
		 * Workspace xml file.
		 * This should always be in your root project directory .idea/workspace.xml
		 */
		workspaceFile = project.rootProject.layout.projectDirectory.dir(".idea").file("workspace.xml")

		/**
		 * Poetry JDK name in IntelliJ idea.
		 *
		 * This is the name of poetry jdk when added to IntelliJ idea by default.
		 * Plugin will not add a new jdk automatically you need to do it manually in project structure -> SDKs.
		 */
		jdkName = "Poetry (${project.name})"

		/**
		 * If you decide to override one of the following values at this place you must assure that directory always exists else you will get an error.
		 * However if you override it in the global configuration you will not get an error in any case.
		 */

		/**
		 * Overrides global Directory containing main python sources.
		 */
		mainSourcesDirectory = layout.projectDirectory.dir("src/main/python")

		/**
		 * Overrides global Directory containing main resources.
		 */
		mainResourcesDirectory = layout.projectDirectory.dir("src/main/resources")

		/**
		 * Overrides global Directory containing test python sources.
		 */
		testSourcesDirectory = layout.projectDirectory.dir("src/test/python")

		/**
		 * Overrides global Directory containing test resources.
		 */
		testResourcesDirectory = layout.projectDirectory.dir("src/test/resources")
	}

	poetryVersionTask {

		/**
		 * Overrides global Poetry command to execute.
		 */
		poetryCmd = "poetry"

		/**
		 * Overrides global pyproject.toml file.
		 */
		projectVersion = project.version.toString().replace("-SNAPSHOT", "a0")

		/**
		 * Overrides global pyproject.toml file.
		 */
		pyprojectFile = layout.projectDirectory.file("pyproject.toml")

	}

	poetryUpdateTask {
		/**
		 * Overrides global Poetry command to execute.
		 */
		poetryCmd = "poetry"

		/**
		 *  Poetry command extra arguments.
		 */
		poetryExtraArgs = null

		/**
		 * Overrides global release flag.
		 * If true gradle will replace all local project dependencies with their online versions.
		 */
		release = false

		/**
		 * Overrides global pyproject.toml file.
		 */
		pyprojectFile = layout.projectDirectory.file("pyproject.toml")

		/**
		 * Poetry.lock file.
		 */
		poetryLockFile = layout.projectDirectory.file("poetry.lock")
	}

	poetryTestTask {

		/**
		 * Overrides global Poetry command to execute.
		 */
		poetryCmd = "poetry"

		/**
		 * Python test command.
		 */
		testCmd = "pytest"

		/**
		 * Python test command extra arguments.
		 */
		testCmdExtraArgs = ["--color=yes"]

		/**
		 * Source files to check changements.
		 */
		sourceFiles = layout.projectDirectory.dir("src").asFileTree.matching {
			include("**/*.py")
		}

		/**
		 * Test report argument option to generate test report.
		 */
		testReportArgument = "--html="

		/**
		 * Test report output file
		 */
		testReport = layout.buildDirectory.file("reports/tests/test.html")

	}

	poetryBuildTask {

		/**
		 * Overrides global Poetry command to execute.
		 */
		poetryCmd = "poetry"

		/**
		 *  Poetry command extra arguments.
		 */
		poetryExtraArgs = null

		/**
		 * Source files to track changements.
		 */
		sourceFiles = layout.projectDirectory.dir("src/main").asFileTree.matching {
			include("**/*.py")
		}

		/**
		 * Directory containing build artifacts.
		 */
		buildDirectory = layout.buildDirectory.dir("dist")

	}
}

```
